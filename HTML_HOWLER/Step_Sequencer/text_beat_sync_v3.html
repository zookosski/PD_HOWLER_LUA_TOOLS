<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HOWLER / TEXT BEAT SYNC v3</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
:root{--chassis:#0b0b0d;--panel:#111116;--surface:#171720;--surface2:#1c1c28;--border:#252535;--border2:#323248;--accent:#00e5ff;--accent2:#ff9100;--accent3:#ff2d55;--green:#39ff14;--purple:#c678ff;--text:#d0d0e0;--text-dim:#484860;--text-muted:#777790;--atk:#00e5ff;--dec:#ffd600;--rel:#ff2d55;--vel:#aaaacc}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--chassis);color:var(--text);font-family:'Share Tech Mono',monospace;min-height:100vh;padding:10px;user-select:none}
.chassis{background:var(--panel);border:1px solid var(--border2);border-radius:6px;padding:12px;position:relative;box-shadow:0 0 0 1px #070708,0 6px 32px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.03);max-width:1440px;margin:0 auto}
.screw{width:9px;height:9px;border-radius:50%;background:radial-gradient(circle at 35% 35%,#333348,#0d0d14);border:1px solid #222232;position:absolute;box-shadow:inset 0 1px 2px rgba(0,0,0,.9)}
.screw::after{content:'';position:absolute;width:5px;height:1px;background:#111120;top:50%;left:50%;transform:translate(-50%,-50%) rotate(45deg)}
.sc-tl{top:6px;left:6px}.sc-tr{top:6px;right:6px}.sc-bl{bottom:6px;left:6px}.sc-br{bottom:6px;right:6px}
/* TOP BAR */
.topbar{display:flex;align-items:center;gap:10px;padding-bottom:9px;border-bottom:1px solid var(--border);flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:7px;flex-shrink:0}
.dot{width:9px;height:9px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.25}}
.brand-text{font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:.2em;color:var(--text-muted)}
.brand-text span{color:var(--accent)}
.vtag{font-size:7px;color:var(--purple);border:1px solid var(--purple);padding:1px 4px;border-radius:2px;opacity:.7;letter-spacing:.1em}
.note-display{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:900;color:var(--accent2);min-width:50px;letter-spacing:.03em}
.sep{width:1px;height:24px;background:var(--border2);flex-shrink:0}
.ctrl-group{display:flex;align-items:center;gap:5px}
.ctrl-label{font-size:8px;letter-spacing:.15em;color:var(--text-dim);text-transform:uppercase;white-space:nowrap}
select,input[type=number]{background:var(--surface);border:1px solid var(--border2);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;padding:3px 5px;border-radius:3px;outline:none;-webkit-appearance:none}
select:focus,input[type=number]:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(0,229,255,.3)}
select option{background:#181820}
input[type=number]{width:56px;text-align:right}
input[type=number].w40{width:40px}
.val-display{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--accent2);min-width:32px;text-align:right}
/* SLIDERS */
input[type=range]{-webkit-appearance:none;appearance:none;background:transparent;cursor:pointer;height:14px}
input[type=range]::-webkit-slider-runnable-track{background:var(--surface);border:1px solid var(--border2);height:3px;border-radius:2px}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:9px;height:9px;border-radius:50%;margin-top:-4px;border:1px solid rgba(0,0,0,.5)}
input[type=range].r-bpm::-webkit-slider-thumb{background:var(--accent2);box-shadow:0 0 4px var(--accent2)}
input[type=range].r-size::-webkit-slider-thumb{background:var(--accent);box-shadow:0 0 4px var(--accent)}
input[type=range].r-atk::-webkit-slider-thumb{background:var(--atk);box-shadow:0 0 3px var(--atk)}
input[type=range].r-dec::-webkit-slider-thumb{background:var(--dec);box-shadow:0 0 3px var(--dec)}
input[type=range].r-rel::-webkit-slider-thumb{background:var(--rel);box-shadow:0 0 3px var(--rel)}
input[type=range].r-vel::-webkit-slider-thumb{background:var(--vel)}
input[type=range].r-pos::-webkit-slider-thumb{background:var(--accent);box-shadow:0 0 3px var(--accent)}
input[type=range].r-opacity::-webkit-slider-thumb{background:var(--purple);box-shadow:0 0 3px var(--purple)}
/* CLOCK MULT PILLS */
.mult-row{display:flex;align-items:center;gap:3px}
.mult-pill{background:var(--surface);border:1px solid var(--border2);color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.04em;padding:2px 7px;border-radius:2px;cursor:pointer;transition:all .1s;white-space:nowrap}
.mult-pill:hover{border-color:var(--accent2);color:var(--accent2)}
.mult-pill.active{background:rgba(255,145,0,.1);border-color:var(--accent2);color:var(--accent2)}
.trip-pill{border-color:var(--purple);color:var(--purple)}
.trip-pill:hover,.trip-pill.active{background:rgba(198,120,255,.1);border-color:var(--purple);color:var(--purple)}
/* FRAME BADGE */
.frame-badge{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,.3);border:1px solid var(--border2);border-radius:3px;padding:3px 8px}
.fb-lbl{font-size:7px;color:var(--text-dim);letter-spacing:.12em}
.fb-val{font-family:'Orbitron',sans-serif;font-size:12px;color:var(--green);letter-spacing:.05em}
.fb-note{font-size:7px;color:var(--text-dim);letter-spacing:.08em}
/* FONT ROW */
.font-row{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);flex-wrap:wrap}
#fontPreviewLabel{font-size:18px;color:var(--accent);min-width:50px;transition:font-family .2s}
/* PAD GRID */
.pad-section{padding:8px 0 4px}
.section-label{font-size:8px;letter-spacing:.22em;color:var(--text-dim);text-transform:uppercase;margin-bottom:6px;padding-left:2px}
.pad-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;margin-bottom:5px}
.pad{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:4px 4px 3px;cursor:pointer;position:relative;transition:border-color .12s}
.pad:hover{border-color:var(--border2)}
.pad.active{border-color:var(--accent);background:#14141e;box-shadow:0 0 7px rgba(0,229,255,.1)}
.pad.selected{border-color:var(--accent2)!important;box-shadow:0 0 9px rgba(255,145,0,.18)!important}
.pad.confirm-clear{border-color:var(--accent3)!important}
.pad-num{font-size:7px;color:var(--text-dim);letter-spacing:.1em;margin-bottom:2px}
.pad-txt{font-size:10px;color:var(--accent);min-height:20px;line-height:20px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:center}
.pad.confirm-clear .pad-txt{color:var(--accent3)}
.clear-ov{position:absolute;inset:0;background:rgba(255,45,85,.12);display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--accent3);letter-spacing:.08em;border-radius:3px;pointer-events:none}
.pad-input-ov{position:absolute;inset:0;z-index:20;background:#0e0e18;border-radius:3px;border:1px solid var(--accent);display:flex;align-items:center;padding:2px 3px}
.pad-input-ov textarea{background:transparent;border:none;color:var(--accent);font-family:'Share Tech Mono',monospace;font-size:10px;resize:none;outline:none;width:100%;height:100%;text-align:center}
.pad-sliders{margin-top:3px;display:flex;flex-direction:column;gap:1px}
.psl-row{display:flex;align-items:center;gap:2px}
.psl-lbl{font-size:7px;color:var(--text-dim);width:7px;flex-shrink:0}
.psl-lbl.a{color:var(--atk)}.psl-lbl.d{color:var(--dec)}.psl-lbl.r{color:var(--rel)}.psl-lbl.v{color:var(--vel)}
.psl-row input[type=range]{flex:1;min-width:0;height:9px}
.psl-row input[type=range]::-webkit-slider-runnable-track{height:2px}
.psl-row input[type=range]::-webkit-slider-thumb{width:7px;height:7px;margin-top:-3px}
/* MAIN AREA */
.main-area{display:flex;gap:8px;align-items:flex-start;padding:8px 0 0;border-top:1px solid var(--border)}
.step-ctrl{width:188px;flex-shrink:0}
.step-ctrl-card{background:var(--surface);border:1px solid var(--border2);border-radius:4px;padding:8px 9px}
.no-sel-hint{color:var(--text-dim);font-size:9px;letter-spacing:.1em;padding:18px 8px;text-align:center;line-height:2}
.sc-row{display:flex;align-items:center;gap:5px;margin-bottom:7px}
.sc-row:last-child{margin-bottom:0}
.sc-lbl{font-size:8px;color:var(--text-dim);letter-spacing:.1em;width:24px;flex-shrink:0}
.sc-val{font-size:8px;color:var(--accent2);width:26px;text-align:right;flex-shrink:0}
.sc-row input[type=range]{flex:1}
.align-btns{display:flex;gap:3px}
.aln-btn{background:var(--surface2);border:1px solid var(--border2);color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:8px;padding:2px 5px;border-radius:2px;cursor:pointer;transition:all .1s}
.aln-btn:hover{border-color:var(--accent);color:var(--accent)}
.aln-btn.active{background:rgba(0,229,255,.1);border-color:var(--accent);color:var(--accent)}
/* PREVIEW */
.preview-panel{flex:1;background:var(--surface);border:1px solid var(--border2);border-radius:4px;overflow:hidden;min-width:0}
.preview-topbar{display:flex;align-items:center;gap:5px;padding:5px 7px;background:var(--surface2);border-bottom:1px solid var(--border);flex-wrap:wrap}
.preview-label{font-size:8px;letter-spacing:.2em;color:var(--text-dim)}
.step-label{font-size:9px;color:var(--accent2);letter-spacing:.1em;flex:1;white-space:nowrap}
.ptb-btn{background:var(--surface);border:1px solid var(--border2);color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:8px;letter-spacing:.08em;padding:3px 7px;border-radius:2px;cursor:pointer;transition:all .12s;white-space:nowrap}
.ptb-btn:hover{color:var(--text)}
.ptb-btn.active{background:rgba(0,229,255,.08);border-color:var(--accent);color:var(--accent)}
.ptb-btn.play-btn{border-color:var(--green);color:var(--green)}
.ptb-btn.play-btn.playing{background:rgba(57,255,20,.08);animation:pg .8s ease-in-out infinite}
@keyframes pg{0%,100%{box-shadow:0 0 4px rgba(57,255,20,.3)}50%{box-shadow:0 0 10px rgba(57,255,20,.6)}}
.ptb-sep{width:1px;height:16px;background:var(--border2);flex-shrink:0}
.gv{font-size:8px;color:var(--accent);min-width:14px;text-align:right}
.preview-canvas-wrap{background:#000;position:relative}
#previewCanvas{display:block;width:100%;max-height:300px}
#dragLayer{position:absolute;inset:0;pointer-events:none}
#dragLayer.active{pointer-events:all}
.drag-handle{position:absolute;transform:translate(-50%,-50%);width:20px;height:20px;border-radius:50%;background:rgba(255,145,0,.2);border:2px solid var(--accent2);cursor:grab;box-shadow:0 0 8px rgba(255,145,0,.4);transition:background .1s}
.drag-handle:hover{background:rgba(255,145,0,.4)}
.drag-handle:active{cursor:grabbing}
.dhx{pointer-events:none;position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.dhx::before,.dhx::after{content:'';position:absolute;background:var(--accent2)}
.dhx::before{width:1px;height:70%;left:50%;transform:translateX(-50%)}
.dhx::after{width:70%;height:1px;top:50%;transform:translateY(-50%)}
#textBBox{position:absolute;border:1px dashed rgba(255,145,0,.4);pointer-events:none;display:none}
.bg-drop{display:flex;align-items:center;gap:3px;border:1px dashed var(--border2);border-radius:3px;padding:2px 7px;cursor:pointer;font-size:8px;color:var(--text-dim);letter-spacing:.1em;transition:all .15s;white-space:nowrap}
.bg-drop:hover{border-color:var(--purple);color:var(--purple)}
.bg-drop.has-img{border-color:var(--purple);color:var(--purple)}
/* BOTTOM BAR */
.bottom-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 0 0;border-top:1px solid var(--border);margin-top:8px;gap:10px;flex-wrap:wrap}
.status-msg{font-size:9px;color:var(--text-dim);letter-spacing:.08em;flex:1;min-height:13px}
.active-count{font-size:9px;color:var(--accent2);letter-spacing:.1em;white-space:nowrap}
.btn{background:var(--surface2);border:1px solid var(--border2);color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:.15em;padding:5px 12px;border-radius:3px;cursor:pointer;transition:all .12s;text-transform:uppercase}
.btn:hover{color:var(--text)}
.btn-clear:hover{border-color:var(--accent3);color:var(--accent3)}
.btn-export{background:rgba(0,229,255,.05);border-color:var(--accent);color:var(--accent)}
.btn-export:hover{background:rgba(0,229,255,.12);box-shadow:0 0 10px rgba(0,229,255,.18)}
.fd-input{background:var(--surface);border:1px solid var(--border2);color:var(--text-muted);font-family:'Share Tech Mono',monospace;font-size:9px;padding:3px 6px;border-radius:3px;outline:none;width:160px}
.fd-input:focus{border-color:var(--accent);color:var(--text)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--chassis)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>
<div class="chassis">
<div class="screw sc-tl"></div><div class="screw sc-tr"></div>
<div class="screw sc-bl"></div><div class="screw sc-br"></div>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">
    <div class="dot"></div>
    <div class="brand-text">HOWLER / <span>TEXT BEAT SYNC</span></div>
    <span class="vtag">V3</span>
  </div>
  <div class="note-display" id="noteDisplay">â™© 1Ã—</div>
  <div class="sep"></div>

  <div class="ctrl-group">
    <span class="ctrl-label">BPM</span>
    <input type="range" class="r-bpm" id="bpmSlider" min="40" max="280" value="120" style="width:80px">
    <span class="val-display" id="bpmVal">120</span>
  </div>
  <div class="sep"></div>

  <!-- NOTE MULTIPLIERS: Ã—1=quarter, Ã—2=8th, Ã—4=16th, Ã—8=32nd + triplet -->
  <div class="ctrl-group">
    <span class="ctrl-label">NOTE DIV</span>
    <div class="mult-row">
      <button class="mult-pill active" data-mult="1">â™© 1Ã—</button>
      <button class="mult-pill"        data-mult="2">â™ª 2Ã—</button>
      <button class="mult-pill"        data-mult="4">â™¬ 4Ã—</button>
      <button class="mult-pill"        data-mult="8">â‹® 8Ã—</button>
      <button class="mult-pill trip-pill" id="tripBtn">3â„ TRIP</button>
    </div>
  </div>
  <div class="sep"></div>

  <!-- FPS (replaces FPB â€” user-facing frame rates) -->
  <div class="ctrl-group">
    <span class="ctrl-label">FPS</span>
    <select id="fpsSelect">
      <option value="24" selected>24</option>
      <option value="25">25</option>
      <option value="30">30</option>
      <option value="60">60</option>
      <option value="120">120</option>
    </select>
  </div>
  <div class="sep"></div>

  <div class="ctrl-group">
    <span class="ctrl-label">CANVAS</span>
    <input type="number" class="w40" id="canvasW" value="1920" min="1" max="7680">
    <span style="color:var(--text-dim);font-size:11px">Ã—</span>
    <input type="number" class="w40" id="canvasH" value="1080" min="1" max="4320">
  </div>
  <div class="sep"></div>

  <!-- LIVE FRAME COUNT SUGGESTION -->
  <div class="frame-badge">
    <span class="fb-lbl">CREATE</span>
    <span class="fb-val" id="fbVal">â€”</span>
    <span class="fb-lbl">FRAMES</span>
    <span class="fb-note" id="fbNote"></span>
  </div>
</div>

<!-- FONT ROW -->
<div class="font-row">
  <div class="ctrl-group">
    <span class="ctrl-label">FONT</span>
    <select id="fontSelect" style="min-width:145px"></select>
  </div>
  <span id="fontPreviewLabel">Aa</span>
  <div class="ctrl-group">
    <span class="ctrl-label">SIZE</span>
    <input type="range" class="r-size" id="sizeSlider" min="12" max="400" value="120" style="width:100px">
    <span class="val-display" id="sizeVal">120</span>
    <span class="ctrl-label">PT</span>
  </div>
  <div class="sep"></div>
  <div class="ctrl-group">
    <span class="ctrl-label" style="white-space:nowrap">FONTS DIR</span>
    <input type="text" class="fd-input" id="fontsDirInput" placeholder="fonts\" value="fonts\">
  </div>
</div>

<!-- PAD GRID -->
<div class="pad-section">
  <div class="section-label">STEP SEQUENCE â€” 16 STEPS</div>
  <div class="pad-grid" id="padGrid"></div>
</div>

<!-- MAIN AREA -->
<div class="main-area">
  <div class="step-ctrl">
    <div class="section-label">STEP PARAMS</div>
    <div class="step-ctrl-card" id="stepCtrlCard">
      <div class="no-sel-hint">â† SELECT AN<br>ACTIVE PAD</div>
    </div>
  </div>

  <div class="preview-panel">
    <div class="preview-topbar">
      <span class="preview-label">â–¸ CANVAS PREVIEW</span>
      <span class="step-label" id="prevLbl">NO STEP SELECTED</span>
      <button class="ptb-btn play-btn" id="playBtn">â–¶ PLAY</button>
      <div class="ptb-sep"></div>
      <button class="ptb-btn" id="eagleBtn">ğŸ‘ ALL</button>
      <div class="ptb-sep"></div>
      <button class="ptb-btn" id="dragModeBtn">âŠ¹ DRAG</button>
      <div class="ptb-sep"></div>
      <button class="ptb-btn" id="gridBtn">âŠ GRID</button>
      <div class="ctrl-group" id="gridCtrl" style="display:none">
        <span class="ctrl-label">C</span>
        <input type="range" id="gridCols" min="2" max="16" value="3" style="width:40px">
        <span class="gv" id="gcv">3</span>
        <span class="ctrl-label">R</span>
        <input type="range" id="gridRows" min="2" max="16" value="3" style="width:40px">
        <span class="gv" id="grv">3</span>
      </div>
      <div class="ptb-sep"></div>
      <label class="bg-drop" id="bgLabel">
        âŠ• BG
        <input type="file" id="bgFile" accept="image/*" style="display:none">
      </label>
      <div class="ctrl-group" id="bgOpcGrp" style="display:none">
        <span class="ctrl-label">OPC</span>
        <input type="range" class="r-opacity" id="bgOpc" min="0" max="100" value="40" style="width:50px">
        <span class="gv" id="bgOpcVal">40%</span>
        <button class="ptb-btn" id="bgClear" style="font-size:7px;padding:2px 4px">âœ•</button>
      </div>
    </div>

    <div class="preview-canvas-wrap" id="previewWrap">
      <canvas id="previewCanvas"></canvas>
      <div id="textBBox"></div>
      <div id="dragLayer"></div>
    </div>
  </div>
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <button class="btn btn-clear" id="clearAllBtn">âŠ˜ CLEAR ALL</button>
  <span class="status-msg" id="statusMsg">READY â€” LEFT-CLICK PAD TO ADD TEXT</span>
  <span class="active-count" id="activeCount">0 / 16 ACTIVE</span>
  <button class="btn btn-export" id="exportBtn">EXPORT PARAMS â†’</button>
</div>
</div>

<script>
// â•â•â• FONTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const FONTS=[
  {name:'Bebas Neue',      file:'BebasNeue-Regular.ttf',      g:'Bebas+Neue'},
  {name:'Anton',           file:'Anton-Regular.ttf',          g:'Anton'},
  {name:'Oswald',          file:'Oswald-Bold.ttf',            g:'Oswald:wght@700'},
  {name:'Black Han Sans',  file:'BlackHanSans-Regular.ttf',   g:'Black+Han+Sans'},
  {name:'Staatliches',     file:'Staatliches-Regular.ttf',    g:'Staatliches'},
  {name:'Righteous',       file:'Righteous-Regular.ttf',      g:'Righteous'},
  {name:'Press Start 2P',  file:'PressStart2P-Regular.ttf',   g:'Press+Start+2P'},
  {name:'VT323',           file:'VT323-Regular.ttf',          g:'VT323'},
  {name:'Orbitron',        file:'Orbitron-Bold.ttf',          g:'Orbitron:wght@700'},
  {name:'Rajdhani',        file:'Rajdhani-Bold.ttf',          g:'Rajdhani:wght@700'},
  {name:'Chakra Petch',    file:'ChakraPetch-Bold.ttf',       g:'Chakra+Petch:wght@700'},
  {name:'Faster One',      file:'FasterOne-Regular.ttf',      g:'Faster+One'},
  {name:'Permanent Marker',file:'PermanentMarker-Regular.ttf',g:'Permanent+Marker'},
  {name:'Pacifico',        file:'Pacifico-Regular.ttf',       g:'Pacifico'},
  {name:'Lobster',         file:'Lobster-Regular.ttf',        g:'Lobster'},
  {name:'Special Elite',   file:'SpecialElite-Regular.ttf',   g:'Special+Elite'},
  {name:'Monoton',         file:'Monoton-Regular.ttf',        g:'Monoton'},
  {name:'Bungee Shade',    file:'BungeeShade-Regular.ttf',    g:'Bungee+Shade'},
  {name:'Black Ops One',   file:'BlackOpsOne-Regular.ttf',    g:'Black+Ops+One'},
  {name:'Creepster',       file:'Creepster-Regular.ttf',      g:'Creepster'},
];
const lf=new Set();
function ensureFont(f){if(lf.has(f.g))return;lf.add(f.g);const l=document.createElement('link');l.rel='stylesheet';l.href=`https://fonts.googleapis.com/css2?family=${f.g}&display=swap`;document.head.appendChild(l);}

// â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Default: attack=0 (instant on), decay=80, release=20, velocity=100
const steps=Array.from({length:16},()=>({active:false,text:'',attack:0,decay:80,release:20,velocity:100,x:50,y:50,align:'center'}));
let selPad=-1,pendClr=-1,editPad=-1;
let gFont=FONTS[0],gSize=120;
let cW=1920,cH=1080;
let clockMult=1,isTriplet=false,fps=24;
let eagleMode=false,dragMode=false,showGrid=false,gridC=3,gridR=3;
let bgImg=null,bgOpc=0.4;
let playing=false,pFrame=0,pTimer=null;

// â•â•â• TIMING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const getBPM=()=>+document.getElementById('bpmSlider').value;
// Step duration in seconds: quarter note / multiplier, optionally tripletized
function stepDur(){
  let d=(60/getBPM())/clockMult;
  if(isTriplet)d*=2/3;
  return d;
}
// Frames per step (how many rendered frames one step occupies in Howler)
const framesPerStep=()=>Math.max(1,Math.round(stepDur()*fps));
// Total frames needed in Howler animation buffer for one full 16-step loop
const totalFrames=()=>framesPerStep()*16;

function updateBadge(){
  const tf=totalFrames(),secs=(tf/fps).toFixed(2);
  document.getElementById('fbVal').textContent=tf;
  document.getElementById('fbNote').textContent=`(${secs}s @ ${fps}fps)`;
  // Update note display
  const names={1:'â™© 1Ã—',2:'â™ª 2Ã—',4:'â™¬ 4Ã—',8:'â‹® 8Ã—'};
  document.getElementById('noteDisplay').textContent=(names[clockMult]||'1Ã—')+(isTriplet?' 3â„':'');
}

// â•â•â• FONT SELECT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fSel=document.getElementById('fontSelect');
FONTS.forEach((f,i)=>{const o=document.createElement('option');o.value=i;o.textContent=f.name;fSel.appendChild(o);});
ensureFont(FONTS[0]);

// â•â•â• PAD GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pg=document.getElementById('padGrid');
function buildGrid(){pg.innerHTML='';for(let i=0;i<16;i++)pg.appendChild(makePad(i));}

function makePad(i){
  const s=steps[i];
  const d=document.createElement('div');
  d.className='pad'+(s.active?' active':'')+(i===selPad?' selected':'');
  d.dataset.index=i;
  // Note: attack slider min=0, value=${s.attack} which defaults to 0
  d.innerHTML=`
    <div class="pad-num">${String(i+1).padStart(2,'0')}</div>
    <div class="pad-txt" id="pt${i}">${s.active?esc(trunc(s.text)):'â€”'}</div>
    <div class="pad-sliders">
      <div class="psl-row"><span class="psl-lbl a">A</span><input type="range" class="r-atk" min="0" max="100" value="${s.attack}" data-i="${i}" data-p="attack"></div>
      <div class="psl-row"><span class="psl-lbl d">D</span><input type="range" class="r-dec" min="0" max="100" value="${s.decay}"   data-i="${i}" data-p="decay"></div>
      <div class="psl-row"><span class="psl-lbl r">R</span><input type="range" class="r-rel" min="0" max="100" value="${s.release}" data-i="${i}" data-p="release"></div>
      <div class="psl-row"><span class="psl-lbl v">V</span><input type="range" class="r-vel" min="0" max="100" value="${s.velocity}" data-i="${i}" data-p="velocity"></div>
    </div>`;
  d.querySelectorAll('input[type=range]').forEach(sl=>{
    sl.addEventListener('mousedown',e=>e.stopPropagation());
    sl.addEventListener('input',e=>{steps[+e.target.dataset.i][e.target.dataset.p]=+e.target.value;if(selPad===+e.target.dataset.i)updCtrl();});
  });
  d.addEventListener('mousedown',e=>{if(e.button===0)pLeft(i);if(e.button===2)pRight(i);});
  d.addEventListener('contextmenu',e=>e.preventDefault());
  return d;
}

function getPad(i){return pg.querySelector(`.pad[data-index="${i}"]`)}
function refPad(i){const o=getPad(i);if(o)pg.replaceChild(makePad(i),o);}
const trunc=(t,n=8)=>t&&t.length>n?t.slice(0,n)+'â€¦':t||'';
const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// â•â•â• PAD INTERACTIONS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pLeft(i){
  if(pendClr!==-1&&pendClr!==i)cancelClr(pendClr);
  if(pendClr===i){cancelClr(i);return;}
  const prev=selPad;selPad=i;
  if(prev!==-1&&prev!==i){const p=getPad(prev);if(p)p.classList.remove('selected');}
  const el=getPad(i);if(el)el.classList.add('selected');
  openInput(i);updCtrl();stat(`EDITING STEP ${i+1}`);
}
function pRight(i){
  if(!steps[i].active)return;
  if(pendClr===i){doClear(i);}
  else{
    if(pendClr!==-1)cancelClr(pendClr);
    pendClr=i;
    const el=getPad(i);
    if(el){el.classList.add('confirm-clear');const t=el.querySelector(`#pt${i}`);if(t)t.innerHTML='âœ• CLEAR?';const ov=document.createElement('div');ov.className='clear-ov';ov.id=`cv${i}`;ov.textContent='RIGHT-CLICK CONFIRM';el.appendChild(ov);}
    stat(`RIGHT-CLICK AGAIN TO CLEAR STEP ${i+1}  |  LEFT-CLICK CANCELS`);
  }
}
function cancelClr(i){
  pendClr=-1;const el=getPad(i);if(!el)return;
  el.classList.remove('confirm-clear');const ov=el.querySelector(`#cv${i}`);if(ov)ov.remove();
  const t=el.querySelector(`#pt${i}`);if(t)t.innerHTML=esc(trunc(steps[i].text))||'â€”';stat('READY');
}
function doClear(i){
  pendClr=-1;steps[i].active=false;steps[i].text='';
  if(selPad===i){selPad=-1;updCtrl();}
  refPad(i);updCount();render();stat(`STEP ${i+1} CLEARED`);
}

// â•â•â• TEXT INPUT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openInput(i){
  closeInput();editPad=i;
  const el=getPad(i);if(!el)return;
  const ov=document.createElement('div');ov.className='pad-input-ov';ov.id='padOv';
  const ta=document.createElement('textarea');ta.value=steps[i].text;ta.placeholder='typeâ€¦';ta.rows=2;
  ov.appendChild(ta);el.appendChild(ov);
  requestAnimationFrame(()=>{ta.focus();ta.select();});
  ta.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();commitInput(i,ta.value);}
    if(e.key==='Escape'){closeInput();if(!steps[i].active){const el2=getPad(i);if(el2)el2.classList.remove('selected');selPad=-1;updCtrl();}}
    e.stopPropagation();
  });
  ta.addEventListener('blur',()=>{setTimeout(()=>{if(editPad===i)commitInput(i,ta.value);},160);});
  ta.addEventListener('input',()=>{steps[i].text=ta.value;render();});
}
function closeInput(){const ov=document.getElementById('padOv');if(ov)ov.remove();editPad=-1;}
function commitInput(i,val){
  closeInput();
  if(val.trim().length>0){
    steps[i].active=true;steps[i].text=val;
    refPad(i);const el=getPad(i);if(el&&selPad===i)el.classList.add('selected');
    updCtrl();render();updCount();stat(`STEP ${i+1} SET: "${trunc(val,20)}"`);
  } else {
    if(!steps[i].active){const el=getPad(i);if(el)el.classList.remove('selected');selPad=-1;}
    refPad(i);updCtrl();stat('READY');
  }
}

// â•â•â• STEP CTRL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const scc=document.getElementById('stepCtrlCard');
const prevLbl=document.getElementById('prevLbl');

function updCtrl(){
  const i=selPad;
  if(i===-1||!steps[i]?.active){
    scc.innerHTML='<div class="no-sel-hint">â† SELECT AN<br>ACTIVE PAD</div>';
    prevLbl.textContent='NO STEP SELECTED';
    if(!eagleMode)render();updBBox();return;
  }
  const s=steps[i];
  prevLbl.textContent=eagleMode?'ALL STEPS VIEW':`STEP ${i+1} PREVIEW`;
  scc.innerHTML=`
    <div class="section-label" style="margin-bottom:7px">STEP ${i+1} â€” ${esc(trunc(s.text,14))}</div>
    <div class="sc-row"><span class="sc-lbl">X POS</span><input type="range" class="r-pos" id="scX" min="0" max="100" value="${s.x}"><span class="sc-val" id="scXv">${s.x}%</span></div>
    <div class="sc-row"><span class="sc-lbl">Y POS</span><input type="range" class="r-pos" id="scY" min="0" max="100" value="${s.y}"><span class="sc-val" id="scYv">${s.y}%</span></div>
    <div class="sc-row"><span class="sc-lbl">ALIGN</span><div class="align-btns">
      <button class="aln-btn ${s.align==='left'?'active':''}"   data-a="left">L</button>
      <button class="aln-btn ${s.align==='center'?'active':''}" data-a="center">C</button>
      <button class="aln-btn ${s.align==='right'?'active':''}"  data-a="right">R</button>
    </div></div>`;
  document.getElementById('scX').addEventListener('input',e=>{steps[i].x=+e.target.value;document.getElementById('scXv').textContent=steps[i].x+'%';render();updHandle();updBBox();});
  document.getElementById('scY').addEventListener('input',e=>{steps[i].y=+e.target.value;document.getElementById('scYv').textContent=steps[i].y+'%';render();updHandle();updBBox();});
  scc.querySelectorAll('.aln-btn').forEach(b=>b.addEventListener('click',()=>{steps[i].align=b.dataset.a;scc.querySelectorAll('.aln-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');render();updHandle();updBBox();}));
  render();updHandle();updBBox();
}

// â•â•â• CANVAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const cv=document.getElementById('previewCanvas');
const ctx=cv.getContext('2d');
const wrap=document.getElementById('previewWrap');

function getScale(){
  const W=cW||1920,H=cH||1080,maxW=wrap.clientWidth||700,maxH=300;
  const sc=Math.min(maxW/W,maxH/H);
  return{W,H,sc,cw:Math.round(W*sc),ch:Math.round(H*sc)};
}

// Measure the rendered bounding box of text for the given step
function measureTxt(s,sc,cw,ch){
  const sz=Math.max(6,Math.round(gSize*sc));
  ctx.font=`${sz}px "${gFont.name}",sans-serif`;
  ctx.textBaseline='middle';ctx.textAlign=s.align;
  const m=ctx.measureText(s.text);
  const tw=m.width,th=sz*1.1;
  const ancX=(s.x/100)*cw,ancY=(s.y/100)*ch;
  let x0=ancX;
  if(s.align==='center')x0=ancX-tw/2;
  if(s.align==='right') x0=ancX-tw;
  return{x0,y0:ancY-th/2,tw,th,ancX,ancY,sz,cx:x0+tw/2,cy:ancY};
}

function render(){
  const{sc,cw,ch}=getScale();
  cv.width=cw;cv.height=ch;
  ctx.fillStyle='#000';ctx.fillRect(0,0,cw,ch);
  if(bgImg){ctx.globalAlpha=bgOpc;ctx.drawImage(bgImg,0,0,cw,ch);ctx.globalAlpha=1;}
  if(eagleMode){
    for(let i=0;i<16;i++)if(steps[i].active)drawTxt(steps[i],sc,cw,ch,steps[i].velocity/100,i===selPad);
  } else {
    const i=playing?playStep():selPad;
    if(i!==-1&&steps[i]?.active){
      let a=steps[i].velocity/100;
      if(playing){const fsp=framesPerStep(),fi=pFrame%fsp;a*=env(fi,fsp,steps[i].attack,steps[i].decay,steps[i].release);}
      drawTxt(steps[i],sc,cw,ch,a,true);
    } else if(!playing){
      ctx.fillStyle='#1a1a30';ctx.font='11px "Share Tech Mono"';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('SELECT AN ACTIVE PAD',cw/2,ch/2);
    }
  }
  if(showGrid)drawGrid(cw,ch);
  if(playing)drawBar(cw,ch);
}

function drawTxt(s,sc,cw,ch,alpha,hi){
  const m=measureTxt(s,sc,cw,ch);
  ctx.font=`${m.sz}px "${gFont.name}",sans-serif`;
  ctx.globalAlpha=Math.max(0,Math.min(1,alpha));
  ctx.fillStyle='#fff';ctx.textBaseline='middle';ctx.textAlign=s.align;
  ctx.fillText(s.text,(s.x/100)*cw,(s.y/100)*ch);
  ctx.globalAlpha=1;
  if(hi&&eagleMode){ctx.strokeStyle='rgba(255,145,0,.45)';ctx.lineWidth=1;ctx.strokeRect(m.x0-2,m.y0-2,m.tw+4,m.th+4);}
}

function drawGrid(cw,ch){
  ctx.strokeStyle='rgba(0,229,255,.18)';ctx.lineWidth=.5;
  for(let c=1;c<gridC;c++){const x=Math.round(cw*c/gridC);ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,ch);ctx.stroke();}
  for(let r=1;r<gridR;r++){const y=Math.round(ch*r/gridR);ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(cw,y);ctx.stroke();}
  ctx.strokeStyle='rgba(0,229,255,.07)';ctx.setLineDash([2,4]);
  ctx.beginPath();ctx.moveTo(cw/2,0);ctx.lineTo(cw/2,ch);ctx.stroke();
  ctx.beginPath();ctx.moveTo(0,ch/2);ctx.lineTo(cw,ch/2);ctx.stroke();
  ctx.setLineDash([]);
}
function drawBar(cw,ch){
  const si=playStep(),sw=cw/16,x=si*sw;
  ctx.fillStyle='rgba(57,255,20,.12)';ctx.fillRect(x,0,sw,ch);
  ctx.fillStyle='rgba(57,255,20,.9)';ctx.fillRect(x,0,sw,2);
}

// â•â•â• BOUNDING BOX OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const bboxEl=document.getElementById('textBBox');
function updBBox(){
  if(!dragMode||selPad===-1||!steps[selPad]?.active){bboxEl.style.display='none';return;}
  const{sc,cw,ch}=getScale();
  const m=measureTxt(steps[selPad],sc,cw,ch);
  const sx=cv.offsetWidth/cw,sy=cv.offsetHeight/ch;
  bboxEl.style.display='block';
  bboxEl.style.left=(m.x0*sx)+'px';bboxEl.style.top=(m.y0*sy)+'px';
  bboxEl.style.width=(m.tw*sx)+'px';bboxEl.style.height=(m.th*sy)+'px';
}

// â•â•â• DRAG HANDLE â€” at VISUAL CENTER of text bbox â•â•â•â•â•â•â•â•â•â•
const dragLayer=document.getElementById('dragLayer');
let dHandle=null,isDrag=false;

function updHandle(){
  if(!dragMode||selPad===-1||!steps[selPad]?.active){if(dHandle){dHandle.remove();dHandle=null;}bboxEl.style.display='none';return;}
  const{sc,cw,ch}=getScale();
  const m=measureTxt(steps[selPad],sc,cw,ch);
  // Visual center of the text bounding box (NOT the alignment anchor)
  const sx=cv.offsetWidth/cw,sy=cv.offsetHeight/ch;
  const hx=m.cx*sx, hy=m.cy*sy;  // cx = x0+tw/2, cy = ancY (middle baseline)
  if(!dHandle){
    dHandle=document.createElement('div');dHandle.className='drag-handle';dHandle.id='dh';
    const x=document.createElement('div');x.className='dhx';dHandle.appendChild(x);
    dragLayer.appendChild(dHandle);attachDrag();
  }
  dHandle.style.left=hx+'px';dHandle.style.top=hy+'px';
  updBBox();
}

function attachDrag(){
  if(!dHandle)return;
  let smx,smy,sx,sy;
  dHandle.addEventListener('mousedown',e=>{
    if(e.button!==0)return;isDrag=true;smx=e.clientX;smy=e.clientY;sx=steps[selPad].x;sy=steps[selPad].y;
    e.stopPropagation();e.preventDefault();
    const{cw,ch}=getScale();
    const cssScX=cv.offsetWidth/cw,cssScY=cv.offsetHeight/ch;
    const onM=e2=>{
      if(!isDrag)return;
      const dx=e2.clientX-smx,dy=e2.clientY-smy;
      // Convert CSS pixel delta â†’ % of canvas
      const nx=Math.max(0,Math.min(100,sx+(dx/cssScX/cw)*100));
      const ny=Math.max(0,Math.min(100,sy+(dy/cssScY/ch)*100));
      steps[selPad].x=Math.round(nx);steps[selPad].y=Math.round(ny);
      syncSl();render();updHandle();
    };
    const onU=()=>{isDrag=false;window.removeEventListener('mousemove',onM);window.removeEventListener('mouseup',onU);};
    window.addEventListener('mousemove',onM);window.addEventListener('mouseup',onU);
  });
}

// Click-to-set position on canvas
cv.addEventListener('click',e=>{
  if(!dragMode||selPad===-1||!steps[selPad]?.active)return;
  const r=cv.getBoundingClientRect();
  steps[selPad].x=Math.max(0,Math.min(100,Math.round(((e.clientX-r.left)/r.width)*100)));
  steps[selPad].y=Math.max(0,Math.min(100,Math.round(((e.clientY-r.top)/r.height)*100)));
  syncSl();render();updHandle();
});

function syncSl(){
  const i=selPad;if(i===-1)return;
  const sx=document.getElementById('scX'),sy=document.getElementById('scY');
  const svx=document.getElementById('scXv'),svy=document.getElementById('scYv');
  if(sx){sx.value=steps[i].x;svx.textContent=steps[i].x+'%';}
  if(sy){sy.value=steps[i].y;svy.textContent=steps[i].y+'%';}
}

// â•â•â• PLAYBACK â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const playStep=()=>Math.floor(pFrame/framesPerStep())%16;
function startPlay(){
  if(playing){stopPlay();return;}
  playing=true;pFrame=0;
  const btn=document.getElementById('playBtn');btn.textContent='â–  STOP';btn.classList.add('playing');
  const fms=Math.max(16,(stepDur()/framesPerStep())*1000);
  pTimer=setInterval(()=>{
    pFrame++;
    document.querySelectorAll('.pad').forEach(p=>{p.style.outline='';p.style.outlineOffset='';});
    const cur=playStep();const el=getPad(cur);
    if(el&&steps[cur].active){el.style.outline='2px solid rgba(57,255,20,.7)';el.style.outlineOffset='1px';}
    render();
  },fms);
}
function stopPlay(){
  playing=false;clearInterval(pTimer);pTimer=null;
  document.querySelectorAll('.pad').forEach(p=>{p.style.outline='';p.style.outlineOffset='';});
  const btn=document.getElementById('playBtn');btn.textContent='â–¶ PLAY';btn.classList.remove('playing');render();
}

// â•â•â• ENVELOPE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// attack=0 â†’ frame 0 is full brightness (no fade-in ramp)
function env(fi,total,atk,dec,rel){
  if(atk===0){
    const dFrames=Math.max(1,Math.floor(dec/100*total));
    if(fi<dFrames)return 1.0;
    const rd=Math.max(1,Math.floor(rel/100*total));
    return Math.max(0,1-(fi-dFrames)/rd);
  }
  const a=Math.max(1,Math.floor(atk/100*total));
  const d=Math.max(1,Math.floor(dec/100*total));
  const r=Math.max(1,Math.floor(rel/100*total));
  if(fi<a)return fi/a;
  if(fi<a+d)return 1.0;
  return Math.max(0,1-(fi-a-d)/r);
}

// â•â•â• TOOLBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('playBtn').addEventListener('click',startPlay);
document.getElementById('eagleBtn').addEventListener('click',()=>{
  eagleMode=!eagleMode;document.getElementById('eagleBtn').classList.toggle('active',eagleMode);
  prevLbl.textContent=eagleMode?'ALL STEPS VIEW':(selPad>-1?`STEP ${selPad+1} PREVIEW`:'NO STEP SELECTED');
  stat(eagleMode?'EAGLE EYE: ALL ACTIVE STEPS VISIBLE':'SINGLE STEP VIEW');render();
});
document.getElementById('dragModeBtn').addEventListener('click',()=>{
  dragMode=!dragMode;document.getElementById('dragModeBtn').classList.toggle('active',dragMode);
  dragLayer.classList.toggle('active',dragMode);cv.style.cursor=dragMode?'crosshair':'default';
  if(!dragMode){if(dHandle){dHandle.remove();dHandle=null;}bboxEl.style.display='none';}else updHandle();
  stat(dragMode?'DRAG: MOVE HANDLE (TEXT VISUAL CENTER) OR CLICK CANVAS':'DRAG MODE OFF');
});
document.getElementById('gridBtn').addEventListener('click',()=>{
  showGrid=!showGrid;document.getElementById('gridBtn').classList.toggle('active',showGrid);
  document.getElementById('gridCtrl').style.display=showGrid?'flex':'none';render();
});
document.getElementById('gridCols').addEventListener('input',e=>{gridC=+e.target.value;document.getElementById('gcv').textContent=gridC;render();});
document.getElementById('gridRows').addEventListener('input',e=>{gridR=+e.target.value;document.getElementById('grv').textContent=gridR;render();});

// BG Image
document.getElementById('bgFile').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const rd=new FileReader();
  rd.onload=ev=>{const img=new Image();img.onload=()=>{bgImg=img;const lbl=document.getElementById('bgLabel');lbl.classList.add('has-img');lbl.childNodes[0].textContent='âŠ™ BG';document.getElementById('bgOpcGrp').style.display='flex';render();};img.src=ev.target.result;};
  rd.readAsDataURL(file);
});
document.getElementById('bgOpc').addEventListener('input',e=>{bgOpc=+e.target.value/100;document.getElementById('bgOpcVal').textContent=e.target.value+'%';render();});
document.getElementById('bgClear').addEventListener('click',()=>{bgImg=null;const lbl=document.getElementById('bgLabel');lbl.classList.remove('has-img');lbl.childNodes[0].textContent='âŠ• BG';document.getElementById('bgOpcGrp').style.display='none';render();});

// Clock multipliers
document.querySelectorAll('.mult-pill[data-mult]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    clockMult=+btn.dataset.mult;
    document.querySelectorAll('.mult-pill[data-mult]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');if(playing){stopPlay();startPlay();}updateBadge();
  });
});
document.getElementById('tripBtn').addEventListener('click',()=>{
  isTriplet=!isTriplet;document.getElementById('tripBtn').classList.toggle('active',isTriplet);
  if(playing){stopPlay();startPlay();}updateBadge();
});

// Global controls
document.getElementById('bpmSlider').addEventListener('input',e=>{document.getElementById('bpmVal').textContent=e.target.value;if(playing){stopPlay();startPlay();}updateBadge();});
document.getElementById('fpsSelect').addEventListener('change',e=>{fps=+e.target.value;if(playing){stopPlay();startPlay();}updateBadge();});
document.getElementById('fontSelect').addEventListener('change',e=>{gFont=FONTS[+e.target.value];ensureFont(gFont);setTimeout(()=>{document.getElementById('fontPreviewLabel').style.fontFamily=`"${gFont.name}"`;render();updHandle();updBBox();},250);});
document.getElementById('sizeSlider').addEventListener('input',e=>{gSize=+e.target.value;document.getElementById('sizeVal').textContent=gSize;render();updHandle();updBBox();});
document.getElementById('canvasW').addEventListener('input',e=>{cW=+e.target.value||1920;updateBadge();render();updHandle();});
document.getElementById('canvasH').addEventListener('input',e=>{cH=+e.target.value||1080;render();updHandle();});

// Clear all
document.getElementById('clearAllBtn').addEventListener('click',()=>{
  if(!confirm('Clear all 16 steps?'))return;
  stopPlay();
  steps.forEach(s=>Object.assign(s,{active:false,text:'',attack:0,decay:80,release:20,velocity:100,x:50,y:50,align:'center'}));
  selPad=-1;pendClr=-1;buildGrid();updCtrl();updCount();stat('ALL STEPS CLEARED');
});

// Export
document.getElementById('exportBtn').addEventListener('click',()=>{
  const bpm=getBPM(),fpsV=fps,fps_step=framesPerStep(),tf=totalFrames();
  const fontsDir=document.getElementById('fontsDirInput').value||'fonts\\';
  const lines=['# HOWLER TEXT BEAT SYNC PARAMS','# Generated by text_beat_sync_v3.html','',
    `tempo=${bpm}`,`fps=${fpsV}`,`clock_mult=${clockMult}`,`triplet=${isTriplet?1:0}`,
    `frames_per_step=${fps_step}`,`total_frames=${tf}`,`steps=16`,
    `canvas_w=${cW}`,`canvas_h=${cH}`,`global_font=${gFont.name}`,
    `global_font_file=${gFont.file}`,`global_size=${gSize}`,`fonts_dir=${fontsDir}`,''
  ];
  for(let i=0;i<16;i++){
    const s=steps[i];
    if(!s.active){lines.push(`step_${i}_active=0`,'');continue;}
    lines.push(`step_${i}_active=1`,`step_${i}_text=${s.text.replace(/"/g,"'")}`,
      `step_${i}_font=${gFont.name}`,`step_${i}_font_file=${gFont.file}`,`step_${i}_size=${gSize}`,
      `step_${i}_x=${s.x}`,`step_${i}_y=${s.y}`,`step_${i}_align=${s.align}`,
      `step_${i}_attack=${s.attack}`,`step_${i}_decay=${s.decay}`,`step_${i}_release=${s.release}`,
      `step_${i}_velocity=${s.velocity}`,'');
  }
  const blob=new Blob([lines.join('\n')],{type:'text/plain'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='text_beat_params.txt';a.click();
  stat(`EXPORTED â€” CREATE ${tf} FRAMES IN HOWLER BEFORE RUNNING SCRIPT`);
});

const stat=m=>document.getElementById('statusMsg').textContent=m;
const updCount=()=>document.getElementById('activeCount').textContent=`${steps.filter(s=>s.active).length}/16 ACTIVE`;
let rzt;window.addEventListener('resize',()=>{clearTimeout(rzt);rzt=setTimeout(()=>{render();updHandle();updBBox();},100);});

// â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildGrid();updCount();updateBadge();
document.getElementById('fontPreviewLabel').style.fontFamily=`"${FONTS[0].name}"`;
setTimeout(render,350);
</script>
</body>
</html>
